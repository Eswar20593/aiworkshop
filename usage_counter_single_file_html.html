<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Usage Counter</title>
  <style>
    :root { --bg:#0b0c10; --card:#151821; --ink:#e7e9ee; --muted:#98a2b3; --accent:#3b82f6; --danger:#ef4444; --warn:#f59e0b; --ring:rgba(59,130,246,.35); }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: var(--bg); color:var(--ink); min-height:100dvh; display:grid; place-items:center; padding:24px; }
    .wrap { width:100%; max-width:520px; background: #101522; border:1px solid #1f2531; border-radius:14px; box-shadow: 0 18px 40px rgba(0,0,0,.35); }
    header, footer { padding:14px 16px; }
    header { border-bottom:1px solid #1f2531; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    header h1 { margin:0; font-size:16px; font-weight:700; letter-spacing:.2px; }
    main { padding:16px; display:grid; gap:14px; }
    .row { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; }
    input[type="text"] { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3446; background:#0f1420; color:var(--ink); outline:none; }
    input[type="text"]::placeholder { color:#5a6578; }
    input[type="text"]:focus { border-color: var(--accent); box-shadow:0 0 0 6px var(--ring); }
    .buttons { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    button { padding:10px 12px; border-radius:10px; border:1px solid #253049; background:#111827; color:var(--ink); font-weight:600; cursor:pointer; }
    button:hover { border-color:#344159; }
    button:active { transform: translateY(1px); }
    button[disabled] { opacity:.55; cursor:not-allowed; }
    .primary { background: linear-gradient(180deg, #1f6bff, #2553d9); border-color:#2c5bd8; }
    .danger { background:#1a1522; border-color:#3b223e; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0e1422; border:1px solid #1f2736; color:var(--muted); font-size:12px; font-weight:600; }
    .countCard { padding:14px; border-radius:12px; background:#0d1321; border:1px solid #1b2436; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .big { font-size:40px; font-weight:800; letter-spacing:.5px; }
    .muted { color:var(--muted); font-size:13px; }
    .status { min-height:20px; font-size:13px; }
    .status.error { color: var(--danger); }
    .status.warn { color: var(--warn); }
    footer { display:flex; justify-content: space-between; align-items:center; gap:12px; border-top:1px solid #1f2531; }
    @media (max-width: 420px) { .buttons { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Usage Counter">
    <header>
      <h1>Usage Counter</h1>
      <span class="pill" id="identity">no name</span>
    </header>

    <main>
      <div class="row">
        <input id="nameInput" type="text" inputmode="latin" autocomplete="off" placeholder="Enter a name (e.g., alice)" aria-label="Name" />
        <button id="startBtn" class="primary">Start</button>
      </div>

      <div class="buttons">
        <button id="incBtn">Increment</button>
        <button id="refreshBtn">Refresh</button>
        <button id="forgetBtn" class="danger">Forget</button>
        <span aria-hidden="true"></span>
      </div>

      <div class="countCard" aria-live="polite" aria-atomic="true">
        <div>
          <div class="muted">Current count</div>
          <div id="countVal" class="big">—</div>
        </div>
        <div class="muted" id="lastUpdated" title="Last updated"></div>
      </div>

      <div id="status" class="status" role="status" aria-live="polite"></div>
    </main>

    <footer>
      <span class="muted">Buttons are disabled until a name is set.</span>
      <span class="muted" id="hint"></span>
    </footer>
  </div>

  <script>
  (function(){
    "use strict";

    const API = "https://api.magiqspark.com/counter/";
    const els = {
      nameInput: document.getElementById("nameInput"),
      startBtn:  document.getElementById("startBtn"),
      incBtn:    document.getElementById("incBtn"),
      refreshBtn:document.getElementById("refreshBtn"),
      forgetBtn: document.getElementById("forgetBtn"),
      status:    document.getElementById("status"),
      countVal:  document.getElementById("countVal"),
      lastUpdated: document.getElementById("lastUpdated"),
      identity:  document.getElementById("identity"),
      hint:      document.getElementById("hint"),
    };

    // In-memory only (no localStorage)
    let currentName = null;
    let inFlight = null; // AbortController for active request

    function setStatus(kind, msg) {
      // kind: "", "warn", "error"
      els.status.className = "status" + (kind ? " " + kind : "");
      els.status.textContent = msg || "";
    }

    function setButtonsEnabled(enabled) {
      [els.incBtn, els.refreshBtn, els.forgetBtn].forEach(b => b.disabled = !enabled);
    }

    function showIdentity(name) {
      els.identity.textContent = name ? `@${name}` : "no name";
    }

    function updateCount(value) {
      els.countVal.textContent = (typeof value === "number" && Number.isFinite(value)) ? String(value) : "—";
      els.lastUpdated.textContent = value == null ? "" : new Date().toLocaleTimeString();
    }

    function cancelInFlight() {
      if (inFlight) { inFlight.abort(); inFlight = null; }
    }

    async function safeFetch(input, init, expectJson=true, timeoutMs=10000) {
      cancelInFlight();
      inFlight = new AbortController();
      const t = setTimeout(() => inFlight.abort(), timeoutMs);
      try {
        const res = await fetch(input, { ...init, signal: inFlight.signal });
        if (!res.ok) {
          let details = "";
          try { details = (await res.text()).trim(); } catch (_) {}
          const msg = details ? truncate(details, 240) : `Request failed (${res.status})`;
          throw new Error(msg);
        }
        return expectJson ? await res.json().catch(() => ({})) : null;
      } finally {
        clearTimeout(t);
        inFlight = null;
      }
    }

    function truncate(str, n) { return (str && str.length > n) ? str.slice(0, n - 1) + "…" : str; }

    function nameFromQuery() {
      const p = new URLSearchParams(location.search);
      const v = (p.get("name") || "").trim();
      return v || null;
    }

    // API actions
    async function doPostIncrement() {
      if (!currentName) return;
      try {
        setStatus("", "");
        await safeFetch(API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: currentName })
        }, /*expectJson*/ false);
      } catch (err) {
        setStatus("error", String(err.message || err));
        throw err;
      }
    }

    async function doGetCount() {
      if (!currentName) return;
      try {
        setStatus("", "");
        const data = await safeFetch(API + "?name=" + encodeURIComponent(currentName), { method: "GET" }, true);
        const count = (data && (data.count ?? data.value ?? data.counter));
        if (typeof count === "number") updateCount(count); else updateCount(null);
      } catch (err) {
        setStatus("error", String(err.message || err));
        throw err;
      }
    }

    // Event handlers
    els.startBtn.addEventListener("click", async () => {
      const name = (els.nameInput.value || "").trim();
      if (!name) { setStatus("warn", "Please enter a name to start."); return; }
      currentName = name;
      showIdentity(currentName);
      setButtonsEnabled(true);
      try { await doPostIncrement(); await doGetCount(); } catch (_) {}
    });

    els.incBtn.addEventListener("click", async () => {
      if (!currentName) { setStatus("warn", "Set a name first."); return; }
      try { await doPostIncrement(); await doGetCount(); } catch (_) {}
    });

    els.refreshBtn.addEventListener("click", async () => {
      if (!currentName) { setStatus("warn", "Set a name first."); return; }
      try { await doGetCount(); } catch (_) {}
    });

    els.forgetBtn.addEventListener("click", () => {
      cancelInFlight();
      currentName = null;
      els.nameInput.value = "";
      showIdentity(null);
      setButtonsEnabled(false);
      updateCount(null);
      setStatus("", "");
    });

    // Enter key triggers Start
    els.nameInput.addEventListener("keydown", (e) => { if (e.key === "Enter") els.startBtn.click(); });

    // Init
    function init() {
      setButtonsEnabled(false);
      updateCount(null);
      setStatus("", "");
      const auto = nameFromQuery();
      if (auto) { els.nameInput.value = auto; els.startBtn.click(); }
      els.hint.textContent = ""; // reserved for future hints (no logs)
    }
    init();
  })();
  </script>
</body>
</html>
